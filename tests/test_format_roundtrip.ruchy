// test_format_roundtrip.ruchy — Format roundtrip tests
//
// Verifies that APR → GGUF → reimport produces identical token outputs.
// Tests the lossless property of format conversion.

import std::fs
import std::process

// --- Helpers (ruchy has no file imports, must be inline) ---

fun run_apr(args) {
    let (stdout, stderr, code) = process::execute("apr", args)?
    if code != 0 { return Err(f"apr failed ({code}): {stderr}") }
    Ok(stdout)
}

fun apr_run_json(model_path, prompt) {
    let stdout = run_apr(["run", model_path, "-p", prompt, "-n", "32", "--json"])?
    Ok(parse_json(stdout))
}

fun load_oracle(slug, prompt_name) {
    let text = fs::read_to_string(f"oracle/{slug}/{prompt_name}.json")?
    Ok(parse_json(text))
}

fun cleanup(path) {
    let (_, _, _) = process::execute("rm", ["-f", path])?
    Ok(())
}

// --- SmolLM-135M roundtrip ---

@test
fun test_roundtrip_smollm_q4k() {
    let reimported = "models/smollm-135m-q4k-reimported.apr"

    // GGUF → reimport to APR
    run_apr(["import", "models/smollm-135m-q4k.gguf", "-o", reimported])?

    // Run both on same prompt
    let oracle = load_oracle("smollm-135m", "completion")?
    let original = apr_run_json("models/smollm-135m-q4k.apr", oracle.prompt)?
    let roundtripped = apr_run_json(reimported, oracle.prompt)?

    // Clean up
    cleanup(reimported)?

    // Assert identical tokens
    assert_eq(roundtripped.tokens, original.tokens,
        f"SmolLM Q4K roundtrip: tokens differ after APR→GGUF→APR")
}

@test
fun test_roundtrip_smollm_q4k_arithmetic() {
    let reimported = "models/smollm-135m-q4k-reimported-arith.apr"

    run_apr(["import", "models/smollm-135m-q4k.gguf", "-o", reimported])?

    let oracle = load_oracle("smollm-135m", "arithmetic")?
    let original = apr_run_json("models/smollm-135m-q4k.apr", oracle.prompt)?
    let roundtripped = apr_run_json(reimported, oracle.prompt)?

    cleanup(reimported)?

    assert_eq(roundtripped.tokens, original.tokens,
        f"SmolLM Q4K roundtrip arithmetic: tokens differ after APR→GGUF→APR")
}

// --- Qwen2-0.5B roundtrip ---

@test
fun test_roundtrip_qwen2_q4k() {
    let reimported = "models/qwen2-0.5b-q4k-reimported.apr"

    run_apr(["import", "models/qwen2-0.5b-q4k.gguf", "-o", reimported])?

    let oracle = load_oracle("qwen2-0.5b", "completion")?
    let original = apr_run_json("models/qwen2-0.5b-q4k.apr", oracle.prompt)?
    let roundtripped = apr_run_json(reimported, oracle.prompt)?

    cleanup(reimported)?

    assert_eq(roundtripped.tokens, original.tokens,
        f"Qwen2 Q4K roundtrip: tokens differ after APR→GGUF→APR")
}

@test
fun test_roundtrip_qwen2_q4k_arithmetic() {
    let reimported = "models/qwen2-0.5b-q4k-reimported-arith.apr"

    run_apr(["import", "models/qwen2-0.5b-q4k.gguf", "-o", reimported])?

    let oracle = load_oracle("qwen2-0.5b", "arithmetic")?
    let original = apr_run_json("models/qwen2-0.5b-q4k.apr", oracle.prompt)?
    let roundtripped = apr_run_json(reimported, oracle.prompt)?

    cleanup(reimported)?

    assert_eq(roundtripped.tokens, original.tokens,
        f"Qwen2 Q4K roundtrip arithmetic: tokens differ after APR→GGUF→APR")
}

// --- GPT-2 roundtrip ---

@test
fun test_roundtrip_gpt2_q4k() {
    let reimported = "models/gpt2-124m-q4k-reimported.apr"

    run_apr(["import", "models/gpt2-124m-q4k.gguf", "-o", reimported])?

    let oracle = load_oracle("gpt2-124m", "completion")?
    let original = apr_run_json("models/gpt2-124m-q4k.apr", oracle.prompt)?
    let roundtripped = apr_run_json(reimported, oracle.prompt)?

    cleanup(reimported)?

    assert_eq(roundtripped.tokens, original.tokens,
        f"GPT-2 Q4K roundtrip: tokens differ after APR→GGUF→APR")
}

@test
fun test_roundtrip_gpt2_q4k_arithmetic() {
    let reimported = "models/gpt2-124m-q4k-reimported-arith.apr"

    run_apr(["import", "models/gpt2-124m-q4k.gguf", "-o", reimported])?

    let oracle = load_oracle("gpt2-124m", "arithmetic")?
    let original = apr_run_json("models/gpt2-124m-q4k.apr", oracle.prompt)?
    let roundtripped = apr_run_json(reimported, oracle.prompt)?

    cleanup(reimported)?

    assert_eq(roundtripped.tokens, original.tokens,
        f"GPT-2 Q4K roundtrip arithmetic: tokens differ after APR→GGUF→APR")
}
