// test_perplexity.ruchy â€” Perplexity bound tests
//
// Verifies that model perplexity stays within expected bounds per model,
// and that Int4 vs Int8 PPL difference is < 0.5.
//
// Model-specific PPL ceilings:
//   SmolLM-135M: 20.0
//   Qwen2-0.5B:  15.0
//   GPT-2 124M:  30.0

import std::process

// --- Helpers (ruchy has no file imports, must be inline) ---

fun run_apr(args) {
    let (stdout, stderr, code) = process::execute("apr", args)?
    if code != 0 { return Err(f"apr failed ({code}): {stderr}") }
    Ok(stdout)
}

fun apr_eval_json(model_path) {
    let stdout = run_apr(["eval", model_path, "--threshold", "50.0", "--json"])?
    Ok(parse_json(stdout))
}

fun abs_diff(a, b) {
    if a > b { a - b } else { b - a }
}

// --- SmolLM-135M perplexity ---

@test
fun test_ppl_smollm_int4_bound() {
    let result = apr_eval_json("models/smollm-135m-int4.apr")?
    assert(result.perplexity < 20.0,
        f"SmolLM Int4 PPL {result.perplexity} exceeds ceiling 20.0")
}

@test
fun test_ppl_smollm_int8_bound() {
    let result = apr_eval_json("models/smollm-135m-int8.apr")?
    assert(result.perplexity < 20.0,
        f"SmolLM Int8 PPL {result.perplexity} exceeds ceiling 20.0")
}

@test
fun test_ppl_smollm_int4_vs_int8() {
    let int4 = apr_eval_json("models/smollm-135m-int4.apr")?
    let int8 = apr_eval_json("models/smollm-135m-int8.apr")?
    let diff = abs_diff(int4.perplexity, int8.perplexity)
    assert(diff < 0.5,
        f"SmolLM Int4/Int8 PPL diff {diff} exceeds 0.5 (Int4={int4.perplexity}, Int8={int8.perplexity})")
}

// --- Qwen2-0.5B perplexity ---

@test
fun test_ppl_qwen2_int4_bound() {
    let result = apr_eval_json("models/qwen2-0.5b-int4.apr")?
    assert(result.perplexity < 15.0,
        f"Qwen2 Int4 PPL {result.perplexity} exceeds ceiling 15.0")
}

@test
fun test_ppl_qwen2_int8_bound() {
    let result = apr_eval_json("models/qwen2-0.5b-int8.apr")?
    assert(result.perplexity < 15.0,
        f"Qwen2 Int8 PPL {result.perplexity} exceeds ceiling 15.0")
}

@test
fun test_ppl_qwen2_int4_vs_int8() {
    let int4 = apr_eval_json("models/qwen2-0.5b-int4.apr")?
    let int8 = apr_eval_json("models/qwen2-0.5b-int8.apr")?
    let diff = abs_diff(int4.perplexity, int8.perplexity)
    assert(diff < 0.5,
        f"Qwen2 Int4/Int8 PPL diff {diff} exceeds 0.5 (Int4={int4.perplexity}, Int8={int8.perplexity})")
}

// --- GPT-2 perplexity ---

@test
fun test_ppl_gpt2_int4_bound() {
    let result = apr_eval_json("models/gpt2-124m-int4.apr")?
    assert(result.perplexity < 30.0,
        f"GPT-2 Int4 PPL {result.perplexity} exceeds ceiling 30.0")
}

@test
fun test_ppl_gpt2_int8_bound() {
    let result = apr_eval_json("models/gpt2-124m-int8.apr")?
    assert(result.perplexity < 30.0,
        f"GPT-2 Int8 PPL {result.perplexity} exceeds ceiling 30.0")
}

@test
fun test_ppl_gpt2_int4_vs_int8() {
    let int4 = apr_eval_json("models/gpt2-124m-int4.apr")?
    let int8 = apr_eval_json("models/gpt2-124m-int8.apr")?
    let diff = abs_diff(int4.perplexity, int8.perplexity)
    assert(diff < 0.5,
        f"GPT-2 Int4/Int8 PPL diff {diff} exceeds 0.5 (Int4={int4.perplexity}, Int8={int8.perplexity})")
}
