// test_token_parity.ruchy — Token match bound tests
//
// Verifies that quantized models (Int4, Int8) produce tokens within bounded
// mismatch tolerance vs the oracle golden outputs.
// - Int4: ≤5 mismatches per 32 tokens
// - Int8: ≤3 mismatches per 32 tokens

import std::fs
import std::process

// --- Helpers (ruchy has no file imports, must be inline) ---

fun run_apr(args) {
    let (stdout, stderr, code) = process::execute("apr", args)?
    if code != 0 { return Err(f"apr failed ({code}): {stderr}") }
    Ok(stdout)
}

fun apr_run_json(model_path, prompt) {
    let stdout = run_apr(["run", model_path, "-p", prompt, "-n", "32", "--json"])?
    Ok(parse_json(stdout))
}

fun load_oracle(slug, prompt_name) {
    let text = fs::read_to_string(f"oracle/{slug}/{prompt_name}.json")?
    Ok(parse_json(text))
}

fun count_mismatches(a, b) {
    let min_len = if a.len() < b.len() { a.len() } else { b.len() }
    let mut m = 0
    for i in range(0, min_len) { if a[i] != b[i] { m = m + 1 } }
    let d = a.len() - b.len()
    if d < 0 { d = -d }
    m + d
}

// --- Int4 token parity tests (≤5 mismatches) ---

@test
fun test_int4_token_parity_smollm_arithmetic() {
    let oracle = load_oracle("smollm-135m", "arithmetic")?
    let result = apr_run_json("models/smollm-135m-int4.apr", oracle.prompt)?
    let mismatches = count_mismatches(result.tokens, oracle.tokens)
    assert(mismatches <= 5, f"SmolLM Int4 arithmetic: {mismatches} mismatches (max 5)")
}

@test
fun test_int4_token_parity_smollm_completion() {
    let oracle = load_oracle("smollm-135m", "completion")?
    let result = apr_run_json("models/smollm-135m-int4.apr", oracle.prompt)?
    let mismatches = count_mismatches(result.tokens, oracle.tokens)
    assert(mismatches <= 5, f"SmolLM Int4 completion: {mismatches} mismatches (max 5)")
}

@test
fun test_int4_token_parity_smollm_code() {
    let oracle = load_oracle("smollm-135m", "code")?
    let result = apr_run_json("models/smollm-135m-int4.apr", oracle.prompt)?
    let mismatches = count_mismatches(result.tokens, oracle.tokens)
    assert(mismatches <= 5, f"SmolLM Int4 code: {mismatches} mismatches (max 5)")
}

@test
fun test_int4_token_parity_smollm_greeting() {
    let oracle = load_oracle("smollm-135m", "greeting")?
    let result = apr_run_json("models/smollm-135m-int4.apr", oracle.prompt)?
    let mismatches = count_mismatches(result.tokens, oracle.tokens)
    assert(mismatches <= 5, f"SmolLM Int4 greeting: {mismatches} mismatches (max 5)")
}

@test
fun test_int4_token_parity_qwen2_arithmetic() {
    let oracle = load_oracle("qwen2-0.5b", "arithmetic")?
    let result = apr_run_json("models/qwen2-0.5b-int4.apr", oracle.prompt)?
    let mismatches = count_mismatches(result.tokens, oracle.tokens)
    assert(mismatches <= 5, f"Qwen2 Int4 arithmetic: {mismatches} mismatches (max 5)")
}

@test
fun test_int4_token_parity_qwen2_completion() {
    let oracle = load_oracle("qwen2-0.5b", "completion")?
    let result = apr_run_json("models/qwen2-0.5b-int4.apr", oracle.prompt)?
    let mismatches = count_mismatches(result.tokens, oracle.tokens)
    assert(mismatches <= 5, f"Qwen2 Int4 completion: {mismatches} mismatches (max 5)")
}

@test
fun test_int4_token_parity_qwen2_code() {
    let oracle = load_oracle("qwen2-0.5b", "code")?
    let result = apr_run_json("models/qwen2-0.5b-int4.apr", oracle.prompt)?
    let mismatches = count_mismatches(result.tokens, oracle.tokens)
    assert(mismatches <= 5, f"Qwen2 Int4 code: {mismatches} mismatches (max 5)")
}

@test
fun test_int4_token_parity_qwen2_greeting() {
    let oracle = load_oracle("qwen2-0.5b", "greeting")?
    let result = apr_run_json("models/qwen2-0.5b-int4.apr", oracle.prompt)?
    let mismatches = count_mismatches(result.tokens, oracle.tokens)
    assert(mismatches <= 5, f"Qwen2 Int4 greeting: {mismatches} mismatches (max 5)")
}

@test
fun test_int4_token_parity_gpt2_arithmetic() {
    let oracle = load_oracle("gpt2-124m", "arithmetic")?
    let result = apr_run_json("models/gpt2-124m-int4.apr", oracle.prompt)?
    let mismatches = count_mismatches(result.tokens, oracle.tokens)
    assert(mismatches <= 5, f"GPT-2 Int4 arithmetic: {mismatches} mismatches (max 5)")
}

@test
fun test_int4_token_parity_gpt2_completion() {
    let oracle = load_oracle("gpt2-124m", "completion")?
    let result = apr_run_json("models/gpt2-124m-int4.apr", oracle.prompt)?
    let mismatches = count_mismatches(result.tokens, oracle.tokens)
    assert(mismatches <= 5, f"GPT-2 Int4 completion: {mismatches} mismatches (max 5)")
}

@test
fun test_int4_token_parity_gpt2_code() {
    let oracle = load_oracle("gpt2-124m", "code")?
    let result = apr_run_json("models/gpt2-124m-int4.apr", oracle.prompt)?
    let mismatches = count_mismatches(result.tokens, oracle.tokens)
    assert(mismatches <= 5, f"GPT-2 Int4 code: {mismatches} mismatches (max 5)")
}

@test
fun test_int4_token_parity_gpt2_greeting() {
    let oracle = load_oracle("gpt2-124m", "greeting")?
    let result = apr_run_json("models/gpt2-124m-int4.apr", oracle.prompt)?
    let mismatches = count_mismatches(result.tokens, oracle.tokens)
    assert(mismatches <= 5, f"GPT-2 Int4 greeting: {mismatches} mismatches (max 5)")
}

// --- Int8 token parity tests (≤3 mismatches) ---

@test
fun test_int8_token_parity_smollm_arithmetic() {
    let oracle = load_oracle("smollm-135m", "arithmetic")?
    let result = apr_run_json("models/smollm-135m-int8.apr", oracle.prompt)?
    let mismatches = count_mismatches(result.tokens, oracle.tokens)
    assert(mismatches <= 3, f"SmolLM Int8 arithmetic: {mismatches} mismatches (max 3)")
}

@test
fun test_int8_token_parity_smollm_completion() {
    let oracle = load_oracle("smollm-135m", "completion")?
    let result = apr_run_json("models/smollm-135m-int8.apr", oracle.prompt)?
    let mismatches = count_mismatches(result.tokens, oracle.tokens)
    assert(mismatches <= 3, f"SmolLM Int8 completion: {mismatches} mismatches (max 3)")
}

@test
fun test_int8_token_parity_smollm_code() {
    let oracle = load_oracle("smollm-135m", "code")?
    let result = apr_run_json("models/smollm-135m-int8.apr", oracle.prompt)?
    let mismatches = count_mismatches(result.tokens, oracle.tokens)
    assert(mismatches <= 3, f"SmolLM Int8 code: {mismatches} mismatches (max 3)")
}

@test
fun test_int8_token_parity_smollm_greeting() {
    let oracle = load_oracle("smollm-135m", "greeting")?
    let result = apr_run_json("models/smollm-135m-int8.apr", oracle.prompt)?
    let mismatches = count_mismatches(result.tokens, oracle.tokens)
    assert(mismatches <= 3, f"SmolLM Int8 greeting: {mismatches} mismatches (max 3)")
}

@test
fun test_int8_token_parity_qwen2_arithmetic() {
    let oracle = load_oracle("qwen2-0.5b", "arithmetic")?
    let result = apr_run_json("models/qwen2-0.5b-int8.apr", oracle.prompt)?
    let mismatches = count_mismatches(result.tokens, oracle.tokens)
    assert(mismatches <= 3, f"Qwen2 Int8 arithmetic: {mismatches} mismatches (max 3)")
}

@test
fun test_int8_token_parity_qwen2_completion() {
    let oracle = load_oracle("qwen2-0.5b", "completion")?
    let result = apr_run_json("models/qwen2-0.5b-int8.apr", oracle.prompt)?
    let mismatches = count_mismatches(result.tokens, oracle.tokens)
    assert(mismatches <= 3, f"Qwen2 Int8 completion: {mismatches} mismatches (max 3)")
}

@test
fun test_int8_token_parity_qwen2_code() {
    let oracle = load_oracle("qwen2-0.5b", "code")?
    let result = apr_run_json("models/qwen2-0.5b-int8.apr", oracle.prompt)?
    let mismatches = count_mismatches(result.tokens, oracle.tokens)
    assert(mismatches <= 3, f"Qwen2 Int8 code: {mismatches} mismatches (max 3)")
}

@test
fun test_int8_token_parity_qwen2_greeting() {
    let oracle = load_oracle("qwen2-0.5b", "greeting")?
    let result = apr_run_json("models/qwen2-0.5b-int8.apr", oracle.prompt)?
    let mismatches = count_mismatches(result.tokens, oracle.tokens)
    assert(mismatches <= 3, f"Qwen2 Int8 greeting: {mismatches} mismatches (max 3)")
}

@test
fun test_int8_token_parity_gpt2_arithmetic() {
    let oracle = load_oracle("gpt2-124m", "arithmetic")?
    let result = apr_run_json("models/gpt2-124m-int8.apr", oracle.prompt)?
    let mismatches = count_mismatches(result.tokens, oracle.tokens)
    assert(mismatches <= 3, f"GPT-2 Int8 arithmetic: {mismatches} mismatches (max 3)")
}

@test
fun test_int8_token_parity_gpt2_completion() {
    let oracle = load_oracle("gpt2-124m", "completion")?
    let result = apr_run_json("models/gpt2-124m-int8.apr", oracle.prompt)?
    let mismatches = count_mismatches(result.tokens, oracle.tokens)
    assert(mismatches <= 3, f"GPT-2 Int8 completion: {mismatches} mismatches (max 3)")
}

@test
fun test_int8_token_parity_gpt2_code() {
    let oracle = load_oracle("gpt2-124m", "code")?
    let result = apr_run_json("models/gpt2-124m-int8.apr", oracle.prompt)?
    let mismatches = count_mismatches(result.tokens, oracle.tokens)
    assert(mismatches <= 3, f"GPT-2 Int8 code: {mismatches} mismatches (max 3)")
}

@test
fun test_int8_token_parity_gpt2_greeting() {
    let oracle = load_oracle("gpt2-124m", "greeting")?
    let result = apr_run_json("models/gpt2-124m-int8.apr", oracle.prompt)?
    let mismatches = count_mismatches(result.tokens, oracle.tokens)
    assert(mismatches <= 3, f"GPT-2 Int8 greeting: {mismatches} mismatches (max 3)")
}
